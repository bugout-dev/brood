# bugout-dev/brood

## What is Brood?

Setting up user registration and login in your application can be challenging and time consuming.
Doing this from scratch takes a lot of planning. Since you're working with sensitive data (emails,
passwords, etc) it's important not to get it wrong.

Giving users the ability to set up groups or teams within which they can share resources adds to this
challenge, and adding payments compounds it significantly.

Brood is a web service that takes care of user management, team management, and payments in your
application as soon as you set it up.

It is a free and open source alternative to systems like AWS Cognito and Auth0.

Brood provides a REST API that you can use either directly from your frontend application or through
your own API or serverless application. It uses a Postgres database to store data about users,
teams, and payments.

Payments are currently supported through Stripe.

Brood has been battle tested in production and has been supporting millions of authentication events
a month since March 2021.

## Using Brood

To get started with Brood, we'll need to generate an authorization token via a POST `/token` request with the following parameters:
- username (string): Username - required
- password (string): User password - required
- token_type (string): Token type - "bugout" by default
- token_note (string, null): Short token description - ""Bugout login token" by default
- restricted (boolean, null): If True, token will be created with restrictions

Once you obtain the token, you can pass it with future HTTP requests by setting the header as `Authorization: Bearer <token>`

### CORS configuration

<!-- Insert the section about CORS configuration. -->

### Client libraries
To make coding against the Brood API easier, you can use one of the following client libraries:  
- [Javascript](https://www.npmjs.com/package/@bugout/bugout-js)  
- [Python](https://pypi.org/project/bugout/)  
- [Go](https://github.com/bugout-dev/bugout-go)  

<!-- These sections should contain example API requests and responses. -->
### User management
As mentioned, user management is one of the main functionalities provided by Brood. You can find, update, create, and delete users, manage their passwords and verify user's email.  
For example, if you wish to create a new user, do a POST `/user` request with
- username (string): Username
- email (string): New user email
- password (string): New user password
- first_name (string, null): User first name
- last_name (string, null): User last name
- application_id (uuid, null): External application user belongs to

Response samples:

Successful response **200**:
```json
{
  "user_id": "a169451c-8525-4352-b8ca-070dd449a1a5",
  "username": "string",
  "first_name": "string",
  "last_name": "string",
  "email": "string",
  "normalized_email": "string",
  "verified": true,
  "created_at": "2019-08-24T14:15:22Z",
  "updated_at": "2019-08-24T14:15:22Z",
  "autogenerated": true,
  "application_id": "48ac72d0-a829-4896-a067-dcb1c2b0f30c"
}
```
Validation error **422**:
```json
{
  "detail": [
    {
      "loc": [
        "string"
      ],
      "msg": "string",
      "type": "string"
    }
  ]
}
```

### Team management
After creating the users, it is possible to group them into teams. To do so you'll need to create the group and invite other users. The users will receive the invitation that they'll be able to accept or revoke.  
For example, to send an invitation make a POST `/groups/{group_id}/invites/send` request with
- group_id (uuid): Group ID
- email (string, null): User email
- user_type (string): User permission in group

If the user doesn't exist in the database, an invitation link will be sent to their email.

Response samples:

Successful response **200**:

```json
{
  "personal": true,
  "message": "string"
}
```
Validation error **422**:
```json
{
  "detail": [
    {
      "loc": [
        "string"
      ],
      "msg": "string",
      "type": "string"
    }
  ]
}
```

### Payments

Brood supports payments through Stripe. Users can ...

<!-- Insert payment examples -->


### To be removed:
- Authorization header as the entrypoint to Brood.
- Using Brood in an API/serverless application vs. frontend - CORS configuration.
- Client libraries: [Javascript](https://www.npmjs.com/package/@bugout/bugout-js),
  [Python](https://pypi.org/project/bugout/), [Go](https://github.com/bugout-dev/bugout-go).
- [API documentation](https://auth.bugout.dev/docs)


## Running Brood

### Setup:

- Clone git repository
- Install postgresql (https://www.postgresql.org/download/linux/ubuntu/)
- Install requirements
- Copy sample.env to dev.env
- Copy alembic.sample.ini to alembic.dev.ini
- Edit variable "sqlalchemy.url = <...>" into alembic.dev.ini
- Run alembic

```
> ./alembic.sh -c alembic.dev.ini upgrade head
```

- Edit in dev.env file BROOD_DB_URI and BROOD_SENDGRID_API_KEY variable. BROOD_SENDGRID_API_KEY you can get in password vault.
- Last command befor start:

```
> source dev.env
```

### Start server:

```
> ./dev.sh

```

### CLI

#### Groups

- Create new group with specified `--name` and `--username` as an owner

```bash
python -m brood.cli groups create --name "bugout-group" --username "neeraj"
```

- Add user to group with specified `--name` as `group_name`, `--username` and `--type` as `member`/`owner`

```bash
python -m brood.cli groups role --name "bugout-group" --username "tim" --type "member" | jq .
```
